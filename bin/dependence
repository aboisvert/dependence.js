#!/usr/bin/env ruby
require 'optparse'
require 'rb-inotify'
require  File.join(File.dirname(__FILE__), "..", "lib/dependence.rb")

options = {:output => "compiled.js"}
OptionParser.new do |opts|
  opts.banner = "Usage: compile.rb js_source_dir [options]"

  opts.on("-o", "--output FILE", "Output .js file") do |file|
    options[:output] = file
  end

  opts.on("-w", "--watch", "Watch src directory for changes and recompile") do |bool|
    options[:watch] = bool
  end
end.parse(ARGV)

if ARGV.length < 1
  puts "You need to inlcude your js src directory"
  exit 1
elsif !File.directory? ARGV[0] 
  puts "Can't find your js source directory: #{ARGV[0]}"
  exit 1
end

options[:input] = ARGV[0]
output_file = options[:output]
compiler = JsCompiler.new(options[:input])

def recompile
  File.delete(output_file) if File.exists?(output_file)
  compiler.compile(output_file)
end

recompile

if options[:watch]
  puts "Watching #{options[:input]} for changes your js files will be compiled automatically"
  FileWatcher.new do
    recompile
  end 
end




